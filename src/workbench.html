<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Build Order Workbench</title>
  <link rel="icon" type="image/png" href="./favicon.png" />
  <link rel="stylesheet" href="./workbench.css" />
</head>
<body>
  <main>
    <section class="card">
      <h1 style="margin:0 0 4px">Build Order Workbench</h1>
      <p style="margin:8px 0 0;font-size:13px;color:var(--muted);line-height:1.6">
        Write a build order in the editor below using a custom scripting language, hit Run, and get a live simulation with a timeline, resource tracking, and scoring. Good for stress-testing timing assumptions without launching a game.
        <br>Data sourced from <a href="https://www.aoe2database.com" target="_blank" rel="noopener noreferrer" style="color:var(--accent)">aoe2database.com</a> & <a href="https://www.youtube.com/c/SpiritOfTheLaw" target="_blank" rel="noopener noreferrer" style="color:var(--accent)">Spirit of the Law</a>.
      </p>
    </section>

    <section class="card">
      <div class="editor-header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px">
        <div style="display:flex;align-items:center;gap:8px">
          <h2 style="margin:0">Build Order Editor</h2>
          <button class="btn btn-utility" onclick="document.getElementById('helpModal').classList.remove('ai-hidden')">Help</button>
          <a class="btn btn-utility" href="__GAME_OBJECTS_HREF__">Item Reference</a>
        </div>
        <div class="editor-header-end" style="display:flex;align-items:center;gap:8px">
          <select id="buildPresetSelect" class="dsl-select"></select>
          <button id="manageBtn" class="btn" style="font-size:12px">Saves</button>
          <button id="aiOpenBtn" class="ai-trigger">
            <span style="font-size:14px">&#x2728;</span>
            Local LLM
            <span id="aiTriggerDot" class="ai-dot ai-dot-idle"></span>
          </button>
        </div>
      </div>
      <textarea id="dslInput"></textarea>
      <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <button id="runBtn" class="btn btn-primary">Run</button>
        <span id="runStatus" class="muted">ready</span>
        <button id="shareBtn" class="btn">Share</button>
        <span style="margin-left:auto;font-size:11px;color:var(--muted)">cmd/ctrl+enter to run</span>
      </div>
      <div id="errorBox"></div>
    </section>

    <section class="card" id="scoresCard">
      <h2>Scores & Health</h2>
      <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted)">Scores</h3>
      <table>
        <thead><tr><th>Criterion</th><th>Value</th></tr></thead>
        <tbody id="scoresBody"></tbody>
      </table>
      <h3 style="margin:14px 0 8px;font-size:14px;color:var(--muted)">Health Metrics</h3>
      <div id="healthContent"></div>
    </section>

    <section class="card">
      <h2>Entity Timeline</h2>
      <div class="tl-controls">
        <div class="tl-scrubber">
          <span id="timeReadout" class="tl-time">0:00 / 0:00</span>
          <input id="timeRange" type="range" min="0" max="0" step="0.5" value="0" class="tl-range" />
          <span class="tl-scale">
            <label for="pxPerSecond">zoom</label>
            <input id="pxPerSecond" type="range" min="1" max="10" step="1" value="2" />
            <span id="pxPerSecondReadout"></span>
          </span>
        </div>
        <div id="scrubStats" class="tl-stats"></div>
        <div id="gatherStats" class="tl-stats" style="margin-top:-4px;margin-bottom:0;font-size:12px"></div>
      </div>
      <div id="entityTimeline" class="timeline-wrap"></div>
    </section>

    <section class="card">
      <h2 id="violationsTitle">Warnings</h2>
      <table>
        <thead><tr><th>Time</th><th>Code</th><th>Message</th></tr></thead>
        <tbody id="violationsBody"></tbody>
      </table>
    </section>

  </main>

  <div id="helpModal" class="ai-modal-backdrop ai-hidden" onclick="if(event.target===this)this.classList.add('ai-hidden')">
    <div class="ai-modal" style="max-width:700px">
      <div class="ai-modal-header">
        <span style="font-weight:600;font-size:15px">Build Order Reference</span>
        <button onclick="document.getElementById('helpModal').classList.add('ai-hidden')" class="btn" style="padding:4px 10px;line-height:1;font-size:16px">&#x2715;</button>
      </div>
      <div class="ai-modal-body" style="font-size:13px;line-height:1.6;gap:16px">

        <div>
          <div style="font-weight:600;margin-bottom:6px">A minimal build order</div>
          <pre class="help-pre">evaluation 15:00      # required &mdash; how long to simulate
ruleset aoe2          # standard AoE2 rules
setting arabia        # standard Arabia start (6 sheep, 2 boar, berries&hellip;)

auto-queue train_villager using town_center  # keep training villagers non-stop
assign villager 1 to sheep
assign villager 2 to sheep
queue build_house using villager 3 then assign to sheep  # build, then gather</pre>
          <p style="margin:6px 0 0;font-size:12px;color:var(--muted)">Need valid action/entity names? <a href="__GAME_OBJECTS_HREF__" target="_blank" rel="noopener" style="color:var(--accent)">Browse all actions, entities &amp; resources &rarr;</a></p>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:8px">Setup lines &mdash; go before any commands</div>
          <table>
            <tbody>
              <tr><td><code>evaluation &lt;MM:SS&gt;</code></td><td><strong>Required.</strong> How long to simulate, e.g. <code>evaluation 15:00</code>.</td></tr>
              <tr><td><code>stop after clicked|completed|depleted|exhausted &lt;target&gt; [xN]</code></td><td>Optional early stop; sim ends at this trigger or evaluation time, whichever comes first.</td></tr>
              <tr><td><code>ruleset aoe2</code></td><td>Use standard AoE2 rules.</td></tr>
              <tr><td><code>setting arabia</code></td><td>Standard Arabia start &mdash; 6 sheep, 2 boar, berries, etc.</td></tr>
              <tr><td><code>debt-floor &lt;N&gt;</code></td><td>Allow resources to go this far negative (default &minus;30).</td></tr>
              <tr><td><code>score time clicked|completed &lt;action&gt; [xN]</code></td><td>Track a timing goal, e.g. Feudal click or 3rd scout.</td></tr>
              <tr><td><code>starting-resource &lt;res&gt; &lt;amount&gt;</code></td><td>Override a starting resource amount.</td></tr>
            </tbody>
          </table>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:6px">Sending villagers to gather</div>
          <pre class="help-pre">assign villager 4 to sheep              # send villager #4 to sheep
assign villager x3 to forest            # send any 3 villagers to wood
assign villager all from gold to farm   # move everyone off gold onto farms</pre>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:6px">Queuing actions &mdash; build, research, train, age up</div>
          <pre class="help-pre">queue build_house using villager 3
queue build_lumber_camp using villager 7 then assign to forest  # build, then chop
auto-queue train_villager using town_center   # keep repeating continuously
stop-auto-queue build_farm                    # cancel an auto-queue
queue advance_feudal_age</pre>
          <p style="margin:6px 0 0;color:var(--muted)"><code>then</code> chains a follow-up: the second command runs as soon as the first finishes.</p>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:6px">Market trading</div>
          <pre class="help-pre">sell 100 wood      # sell 100 wood for gold
buy 100 food       # buy exactly 100 food with gold
sell 500 stone     # expands to five 100-stone market actions</pre>
          <p style="margin:6px 0 0;color:var(--muted)">Amounts must be positive multiples of <code>100</code>. Use <code>buy</code>/<code>sell</code> (not <code>trade X for Y</code>).</p>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:6px">Timing and triggers</div>
          <p style="margin:0 0 8px;color:var(--muted)">Use <code>at</code> to schedule at a fixed time, or <code>after</code> to react to in-game events:</p>
          <pre class="help-pre">at 4:30 queue lure_deer
after villager 18 queue advance_feudal_age             # click up at 18 pop
after completed advance_feudal_age queue build_stable  # stable as soon as feudal hits
after depleted boar assign villager x3 from boar to sheep
after every depleted sheep assign villager from sheep to boar deer  # repeats each time</pre>
          <table style="margin-top:8px">
            <tbody>
              <tr><td><code>after &lt;entity&gt; &lt;N&gt;</code></td><td>When your Nth entity is created</td></tr>
              <tr><td><code>after completed|clicked &lt;action&gt;</code></td><td>When action finishes or is clicked <em>(once)</em></td></tr>
              <tr><td><code>after depleted|exhausted &lt;node&gt;</code></td><td>When a resource node runs out <em>(once)</em></td></tr>
              <tr><td><code>after every &hellip;</code></td><td>Same triggers, but fires <em>every</em> time, not just the first</td></tr>
              <tr><td><code>after &hellip; after &hellip;</code></td><td>Chain conditions &mdash; both must happen before the command runs</td></tr>
              <tr><td><code>on &hellip;</code></td><td>Alias for <code>after every</code></td></tr>
            </tbody>
          </table>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:6px">Picking villagers and resources</div>
          <p style="margin:0 0 6px;color:var(--muted)">Selectors appear in <code>using</code>, <code>from</code>, and <code>to</code> clauses:</p>
          <table>
            <thead><tr><th>Villager selector</th><th>Meaning</th></tr></thead>
            <tbody>
              <tr><td><code>villager</code></td><td>Any one available villager</td></tr>
              <tr><td><code>villager 3</code></td><td>The specific 3rd villager created</td></tr>
              <tr><td><code>villager x3</code></td><td>Any 3 villagers</td></tr>
              <tr><td><code>villager all</code></td><td>Every villager of that type</td></tr>
              <tr><td><code>villager from sheep</code></td><td>A villager currently gathering sheep</td></tr>
            </tbody>
          </table>
          <p style="margin:8px 0 0;color:var(--muted)"><strong>Resource nodes:</strong> <code>sheep</code> &middot; <code>boar</code> &middot; <code>berries</code> &middot; <code>forest</code> &middot; <code>gold_mine</code> &middot; <code>straggler_trees</code> &middot; <code>farms</code> &middot; <code>idle</code> &middot; <code>created</code></p>
        </div>

        <details style="border:1px solid var(--line);border-radius:8px;padding:10px 12px">
          <summary style="font-weight:600;cursor:pointer;user-select:none;color:var(--ink)">Full syntax reference</summary>
          <pre class="help-pre" style="margin-top:10px;border:none;padding:0"># Preamble
evaluation &lt;MM:SS&gt;
ruleset &lt;name&gt; | setting &lt;name&gt;
debt-floor &lt;N&gt; | starting-resource &lt;resource&gt; &lt;amount&gt;
human-delay &lt;action&gt; &lt;chance&gt; &lt;minSec&gt; &lt;maxSec&gt;
score time completed|clicked &lt;action&gt; [xN]
stop after clicked|completed|depleted|exhausted &lt;target&gt; [xN]

# Commands
[at &lt;MM:SS&gt;] [after [every] &lt;condition&gt;] &lt;directive&gt;
[at &lt;MM:SS&gt;] [after [every] &lt;condition&gt;] queue &lt;action&gt; &hellip; then &lt;directive&gt;

# Directives
queue &lt;action&gt; [xN] [using &lt;selector&gt;[, &hellip;]] [from &lt;node&gt;&hellip;]
assign &lt;actorType&gt; &lt;N | xN | all&gt; [from &lt;node&gt;&hellip;] to &lt;node&gt;&hellip;
auto-queue &lt;action&gt; [using &lt;actorType&gt;] [from &lt;node&gt;&hellip;]
stop-auto-queue &lt;action&gt; [using &lt;actorType&gt;]
spawn-assign &lt;entityType&gt; to &lt;node&gt;
sell &lt;amount&gt; &lt;resource&gt;   # positive multiple of 100, non-gold
buy &lt;amount&gt; &lt;resource&gt;    # positive multiple of 100, non-gold</pre>
        </details>


      </div>
    </div>
  </div>

  <div id="aiModal" class="ai-modal-backdrop ai-hidden" role="dialog" aria-modal="true" aria-labelledby="aiModalTitle">
    <div class="ai-modal">
      <div class="ai-modal-header">
        <div class="ai-modal-title">
          <span style="font-size:16px">&#x2728;</span>
          <span id="aiModalTitle" style="font-weight:600;font-size:15px">Local LLM &mdash; Build Order Generator</span>
          <span id="aiStatusBadge" class="ai-badge ai-badge-idle">
            <span id="aiStatusDot" class="ai-dot ai-dot-idle"></span>
            <span id="aiStatusText">Not loaded</span>
          </span>
        </div>
        <button id="aiModalClose" class="btn" style="padding:4px 10px;line-height:1;font-size:16px">&#x2715;</button>
      </div>
      <div class="ai-modal-body">
        <p style="margin:0 0 6px;font-size:13px;color:var(--muted)">Runs <strong>LFM2.5-1.2B</strong> fully in your browser via WebGPU &mdash; no server, no API key.<br>Downloads ~600 MB on first load.
        <br/>&#x26A0;&#xFE0F; <em>Tech demo.</em> Output quality is hit-or-miss (mostly miss) &mdash; don't expect it to really work, but it's pretty cool that it runs at all. Inspired by <a href="https://huggingface.co/spaces/webml-community/GPT-OSS-WebGPU" target="_blank" rel="noopener noreferrer" style="color:var(--accent)">GPT-OSS-WebGPU</a>.</p>
        <div id="aiLoadSection">
          <button id="aiLoadBtn" class="btn btn-primary">Load model</button>
        </div>
        <div id="aiProgressSection" style="display:none">
          <div class="ai-progress"><div id="aiProgressBar" class="ai-progress-bar" style="width:0%"></div></div>
          <div id="aiProgressLabel" style="font-size:12px;color:var(--muted);margin-top:6px;text-align:center">Starting&hellip;</div>
        </div>
        <textarea id="aiPrompt" disabled class="ai-textarea" placeholder="Paste your DSL here, or describe your strategy from scratch&hellip;"></textarea>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="aiGenBtn" class="btn btn-primary" disabled><span id="aiGenLabel">Generate DSL</span></button>
          <button id="aiStopBtn" class="btn btn-stop" style="display:none">Stop</button>
          <button id="aiApplyBtn" class="btn" style="display:none">Apply to editor &#x21B5;</button>
        </div>
        <pre id="aiOutput" class="ai-output" style="display:none"></pre>
      </div>
    </div>
  </div>

  <div id="manageModal" class="ai-modal-backdrop ai-hidden" onclick="if(event.target===this)this.classList.add('ai-hidden')">
    <div class="ai-modal" style="max-width:480px">
      <div class="ai-modal-header">
        <span style="font-weight:600;font-size:15px">Saved Builds</span>
        <button onclick="document.getElementById('manageModal').classList.add('ai-hidden')" class="btn" style="padding:4px 10px;line-height:1;font-size:16px">&#x2715;</button>
      </div>
      <div class="ai-modal-body" style="gap:10px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="saveBuildName" type="text" placeholder="Name this buildâ€¦" style="flex:1;padding:6px 10px;border:1px solid var(--line);border-radius:6px;background:var(--bg);color:var(--ink);font-size:13px;outline:none" />
          <button id="saveBuildBtn" class="btn btn-primary">Save current</button>
        </div>
        <div id="savedBuildsList"></div>
      </div>
    </div>
  </div>

  <footer style="position:relative;z-index:1;text-align:center;padding:12px 0 24px 0;font-size:13px;color:var(--ink)">
    <a href="https://github.com/wraitii/build-order-workbench" target="_blank" rel="noopener" style="color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:7px">
      <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      wraitii/build-order-workbench
    </a>
  </footer>

  <script>document.addEventListener('keydown',function(e){if(e.key==='Escape'){document.getElementById('helpModal').classList.add('ai-hidden');document.getElementById('manageModal').classList.add('ai-hidden');}});</script>
  <script id="__bootstrap__" type="application/json">null</script>
  <script src="./workbench.ts"></script>
</body>
</html>
