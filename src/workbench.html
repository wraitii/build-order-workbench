<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Build Order Workbench</title>
  <link rel="stylesheet" href="./workbench.css" />
</head>
<body>
  <main>
    <section class="card">
      <h1 style="margin:0 0 4px">Build Order Workbench</h1>
      <p style="margin:8px 0 0;font-size:13px;color:var(--muted);line-height:1.6">
        Write a build order in the editor below using a custom scripting language, hit Run, and get a live simulation with a timeline, resource tracking, and scoring. Good for stress-testing timing assumptions without launching a game.
        <br>Data sourced from <a href="https://www.aoe2database.com" target="_blank" rel="noopener noreferrer" style="color:var(--accent)">aoe2database.com</a>.
      </p>
    </section>

    <section class="card">
      <div class="editor-header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px">
        <div style="display:flex;align-items:baseline;gap:8px">
          <h2 style="margin:0">Build Order Editor</h2>
          <button onclick="document.getElementById('helpModal').classList.remove('ai-hidden')" style="border:none;background:none;padding:0;cursor:pointer;font-size:11px;font-weight:500;color:var(--muted);letter-spacing:.3px">? help</button>
        </div>
        <div class="editor-header-end" style="display:flex;align-items:center;gap:8px">
          <select id="buildPresetSelect" class="dsl-select"></select>
          <button id="aiOpenBtn" class="ai-trigger">
            <span style="font-size:14px">&#x2728;</span>
            Local LLM
            <span id="aiTriggerDot" class="ai-dot ai-dot-idle"></span>
          </button>
        </div>
      </div>
      <textarea id="dslInput"></textarea>
      <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <button id="runBtn" class="btn btn-primary">Run</button>
        <span id="runStatus" class="muted">ready</span>
        <span style="margin-left:auto;font-size:11px;color:var(--muted)">cmd/ctrl+enter to run</span>
      </div>
      <div id="errorBox"></div>
    </section>

    <section class="card" id="scoresCard">
      <h2>Scores</h2>
      <table>
        <thead><tr><th>Criterion</th><th>Value</th></tr></thead>
        <tbody id="scoresBody"></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Entity Timeline</h2>
      <div class="tl-controls">
        <div class="tl-scrubber">
          <span id="timeReadout" class="tl-time">0:00 / 0:00</span>
          <input id="timeRange" type="range" min="0" max="0" step="0.5" value="0" class="tl-range" />
          <span class="tl-scale">
            <label for="pxPerSecond">zoom</label>
            <input id="pxPerSecond" type="range" min="1" max="10" step="1" value="2" />
            <span id="pxPerSecondReadout"></span>
          </span>
        </div>
        <div id="scrubStats" class="tl-stats"></div>
        <div id="gatherStats" class="tl-stats" style="margin-top:-4px;margin-bottom:0;font-size:12px"></div>
      </div>
      <div id="entityTimeline" class="timeline-wrap"></div>
    </section>

    <section class="card">
      <h2 id="violationsTitle">Warnings</h2>
      <table>
        <thead><tr><th>Time</th><th>Code</th><th>Message</th></tr></thead>
        <tbody id="violationsBody"></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Health Metrics</h2>
      <div id="healthContent"></div>
    </section>
  </main>

  <div id="helpModal" class="ai-modal-backdrop ai-hidden" onclick="if(event.target===this)this.classList.add('ai-hidden')">
    <div class="ai-modal" style="max-width:700px">
      <div class="ai-modal-header">
        <span style="font-weight:600;font-size:15px">DSL Reference</span>
        <button onclick="document.getElementById('helpModal').classList.add('ai-hidden')" class="btn" style="padding:4px 10px;line-height:1;font-size:16px">&#x2715;</button>
      </div>
      <div class="ai-modal-body" style="font-size:13px;line-height:1.6;gap:14px">

        <div>
          <div style="font-weight:600;margin-bottom:6px;color:var(--ink)">Header &mdash; declare before commands</div>
          <pre style="margin:0;padding:10px 12px;background:#fff;border:1px solid var(--line);border-radius:8px;font-size:12px;white-space:pre;overflow-x:auto">evaluation &lt;MM:SS&gt;                    # required &mdash; how long to simulate
debt-floor &lt;N&gt;                         # allow debt down to N (default -30)
start with &lt;entity&gt;[, &lt;entity&gt;...]    # starting units/buildings
starting-resource &lt;resource&gt; &lt;amount&gt;  # override a starting resource</pre>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:6px;color:var(--ink)">Commands</div>
          <pre style="margin:0;padding:10px 12px;background:#fff;border:1px solid var(--line);border-radius:8px;font-size:12px;white-space:pre;overflow-x:auto">queue &lt;action&gt; [xN] [using &lt;actor&gt;[, ...]] [from &lt;node&gt;...]
auto-queue &lt;action&gt; [using &lt;actorType&gt;] [from &lt;node&gt;...]
stop-auto-queue &lt;action&gt; [using &lt;actorType&gt;]
assign &lt;actorType&gt; &lt;N | xN | all&gt; [from &lt;node&gt;...] to &lt;node&gt;...
spawn-assign &lt;entityType&gt; to &lt;node&gt;   # auto-assign new entities on spawn</pre>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:6px;color:var(--ink)">Timing &amp; conditions &mdash; prefix any command</div>
          <pre style="margin:0;padding:10px 12px;background:#fff;border:1px solid var(--line);border-radius:8px;font-size:12px;white-space:pre;overflow-x:auto">at &lt;MM:SS&gt; &lt;command&gt;
after &lt;entityType&gt; &lt;N&gt; &lt;command&gt;               # after Nth entity is ready
after completed|clicked &lt;action&gt; &lt;command&gt;      # fires once
after depleted|exhausted &lt;node&gt; &lt;command&gt;       # fires once when node empties
after every completed|clicked &lt;action&gt; &lt;command&gt;# fires every matching event
after every depleted|exhausted &lt;node&gt; &lt;command&gt; # fires every matching event
after completed &lt;a&gt; after completed &lt;b&gt; &lt;command&gt; # chain conditions; no fixed time needed
on completed|clicked &lt;action&gt; &lt;command&gt;         # fires every time
on depleted|exhausted &lt;node&gt; &lt;command&gt;          # fires every time</pre>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:6px;color:var(--ink)">Scoring &amp; misc</div>
          <pre style="margin:0;padding:10px 12px;background:#fff;border:1px solid var(--line);border-radius:8px;font-size:12px;white-space:pre;overflow-x:auto">score time completed|clicked &lt;action&gt; [xN]       # lower time = better score
human-delay &lt;action&gt; &lt;chance&gt; &lt;minSec&gt; &lt;maxSec&gt; # simulate reaction time
# anything after a hash is a comment</pre>
        </div>

        <div>
          <div style="font-weight:600;margin-bottom:4px;color:var(--ink)">Tips</div>
          <ul style="margin:0;padding-left:18px;color:var(--muted)">
            <li><strong>Actor selectors</strong> &mdash; <code>villager</code> (any idle one), <code>villager 3</code> / <code>villager-3</code> (the 3rd villager specifically), <code>villager x2</code> (two of them), <code>villager all</code> (everyone of that type)</li>
            <li><strong>Filtering actors by where they are</strong> &mdash; append <code>from &lt;node&gt;...</code> to restrict to actors currently on those nodes. E.g. <code>assign villager x3 from sheep boar_lured to forest</code> pulls 3 villagers who are on sheep <em>or</em> boar_lured and sends them to wood. <code>idle</code> matches anyone not currently gathering.</li>
            <li><strong>Node selectors</strong> &mdash; resource names (<code>food</code>, <code>wood</code>, <code>gold</code>&hellip;) match any node of that type; node ids (<code>sheep</code>, <code>forest</code>, <code>boar_lured</code>&hellip;) match a specific node prototype</li>
            <li>Cmd/Ctrl+Enter runs the simulation from the editor</li>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <div id="aiModal" class="ai-modal-backdrop ai-hidden" role="dialog" aria-modal="true" aria-labelledby="aiModalTitle">
    <div class="ai-modal">
      <div class="ai-modal-header">
        <div class="ai-modal-title">
          <span style="font-size:16px">&#x2728;</span>
          <span id="aiModalTitle" style="font-weight:600;font-size:15px">Local LLM &mdash; Build Order Generator</span>
          <span id="aiStatusBadge" class="ai-badge ai-badge-idle">
            <span id="aiStatusDot" class="ai-dot ai-dot-idle"></span>
            <span id="aiStatusText">Not loaded</span>
          </span>
        </div>
        <button id="aiModalClose" class="btn" style="padding:4px 10px;line-height:1;font-size:16px">&#x2715;</button>
      </div>
      <div class="ai-modal-body">
        <p style="margin:0 0 6px;font-size:13px;color:var(--muted)">Runs <strong>LFM2.5-1.2B</strong> fully in your browser via WebGPU &mdash; no server, no API key.<br>Downloads ~600 MB on first load.
        <br/>&#x26A0;&#xFE0F; <em>Tech demo.</em> Output quality is hit-or-miss (mostly miss) &mdash; don't expect it to really work, but it's pretty cool that it runs at all. Inspired by <a href="https://huggingface.co/spaces/webml-community/GPT-OSS-WebGPU" target="_blank" rel="noopener noreferrer" style="color:var(--accent)">GPT-OSS-WebGPU</a>.</p>
        <div id="aiLoadSection">
          <button id="aiLoadBtn" class="btn btn-primary">Load model</button>
        </div>
        <div id="aiProgressSection" style="display:none">
          <div class="ai-progress"><div id="aiProgressBar" class="ai-progress-bar" style="width:0%"></div></div>
          <div id="aiProgressLabel" style="font-size:12px;color:var(--muted);margin-top:6px;text-align:center">Starting&hellip;</div>
        </div>
        <textarea id="aiPrompt" disabled class="ai-textarea" placeholder="Paste your DSL here, or describe your strategy from scratch&hellip;"></textarea>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="aiGenBtn" class="btn btn-primary" disabled><span id="aiGenLabel">Generate DSL</span></button>
          <button id="aiStopBtn" class="btn btn-stop" style="display:none">Stop</button>
          <button id="aiApplyBtn" class="btn" style="display:none">Apply to editor &#x21B5;</button>
        </div>
        <pre id="aiOutput" class="ai-output" style="display:none"></pre>
      </div>
    </div>
  </div>

  <footer style="position:relative;z-index:1;text-align:center;padding:12px 0 24px 0;font-size:13px;color:var(--ink)">
    <a href="https://github.com/wraitii/build-order-workbench" target="_blank" rel="noopener" style="color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:7px">
      <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      wraitii/build-order-workbench
    </a>
  </footer>

  <script>document.addEventListener('keydown',function(e){if(e.key==='Escape')document.getElementById('helpModal').classList.add('ai-hidden');});</script>
  <script id="__bootstrap__" type="application/json">null</script>
  <script src="./workbench.ts"></script>
</body>
</html>
